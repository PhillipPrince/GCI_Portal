@model List<GCI_Admin.Models.Assembly>


@{
    ViewData["Title"] = "Assemblies";
}

<!-- Page Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <h2 class="fw-bold mb-1">Church Assemblies</h2>
        <p class="text-muted mb-0">Manage church branches and assembly information</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="#" class="btn btn-primary btn-lg" id="openAssemblyModalBtn">
            <i class="fa fa-plus-circle me-2"></i>Create New Assembly
        </a>
    </div>
</div>

<!-- Quick Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-4 col-6">
        <div class="card border-0 shadow-sm stat-card">
            <div class="card-body d-flex align-items-center">
                <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                    <i class="fa fa-building text-primary fa-2x"></i>
                </div>
                <div class="ms-3">
                    <h6 class="text-muted mb-1">Total Assemblies</h6>
                    <h3 class="fw-bold mb-0" id="totalAssemblies">0</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 col-6">
        <div class="card border-0 shadow-sm stat-card">
            <div class="card-body d-flex align-items-center">
                <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                    <i class="fa fa-map-marker text-success fa-2x"></i>
                </div>
                <div class="ms-3">
                    <h6 class="text-muted mb-1">Locations</h6>
                    <h3 class="fw-bold mb-0" id="totalLocations">0</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 col-6">
        <div class="card border-0 shadow-sm stat-card">
            <div class="card-body d-flex align-items-center">
                <div class="bg-info bg-opacity-10 p-3 rounded-circle">
                    <i class="fa fa-calendar text-info fa-2x"></i>
                </div>
                <div class="ms-3">
                    <h6 class="text-muted mb-1">Added This Month</h6>
                    <h3 class="fw-bold mb-0" id="monthAssemblies">0</h3>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="assemblyModal" tabindex="-1" aria-labelledby="assemblyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h5 class="modal-title" id="assemblyModalLabel">
                    <i class="fa fa-building me-2"></i>
                    <span id="modalTitle">Add New Assembly</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body" id="assemblyModalBody">
                <form id="assemblyForm">
                    <div class="mb-3">
                        <label for="assemblyName" class="form-label">Assembly Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="assemblyName" name="Name" placeholder="Enter assembly name" required>
                    </div>

                    <div class="mb-3">
                        <label for="assemblyLocation" class="form-label">Location <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="assemblyLocation" name="Location" placeholder="Enter location" required>
                    </div>

                    <div class="mb-3">
                        <label for="assemblyDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="assemblyDescription" name="Description" rows="3" placeholder="Optional description"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="assemblyEmail" class="form-label">Email (Optional)</label>
                        <input type="email" class="form-control" id="assemblyEmail" name="ContactEmail" placeholder="Enter email">
                    </div>

                    <div class="mb-3">
                        <label for="assemblyPhone" class="form-label">Phone (Optional)</label>
                        <input type="text" class="form-control" id="assemblyPhone" name="ContactPhone" placeholder="Enter phone number">
                    </div>
                </form>

                <!-- Loading Spinner -->
                <div class="text-center p-4 d-none" id="assemblyLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAssemblyForm()" id="saveAssemblyBtn">
                    <i class="fa fa-save me-1"></i>Save Assembly
                </button>
            </div>

        </div>
    </div>
</div>

<!-- Filter Bar -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-end-0">
                        <i class="fa fa-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-start-0" id="assemblySearch" placeholder="Search assemblies...">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-outline-secondary me-2" onclick="clearFilters()">
                    <i class="fa fa-times me-1"></i>Clear
                </button>
                <button class="btn btn-primary" onclick="applyFilters()">
                    <i class="fa fa-filter me-1"></i>Apply
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assemblies Table -->

<div id="assembliesTableContainer">
    @await Html.PartialAsync("_AssembliesTable", Model)

</div>


@section Scripts {

    <script>

      
        let assemblies = [];

        $(document).ready(function () {
            loadAssemblies();
            initializeDataTable();

             $('#openAssemblyModalBtn').on('click', function (e) {
                e.preventDefault(); // prevent navigation
                $('#assemblyModal').modal('show'); // open modal

                // Optional: reset the form every time modal is opened
                $('#assemblyForm')[0].reset();
                $('#assemblyLoading').addClass('d-none');
                $('#saveAssemblyBtn').prop('disabled', false);
                $('#modalTitle').text('Add New Assembly');
            });
        });

        function loadAssemblies() {
            $.get('@Url.Action("GetAssemblies", "Assembly")', function (data) {
                assemblies = data;
                updateStats();
            });
        }

        function updateStats() {

            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const monthAssemblies = assemblies.filter(a => {
                const created = new Date(a.createdAt);
                return created.getMonth() === currentMonth &&
                       created.getFullYear() === currentYear;
            }).length;

            const uniqueLocations = [...new Set(assemblies.map(a => a.location))];

            $('#totalAssemblies').text(assemblies.length);
            $('#totalLocations').text(uniqueLocations.length);
            $('#monthAssemblies').text(monthAssemblies);
        }

        function initializeDataTable() {

            if ($.fn.DataTable.isDataTable('#assembliesTable')) {
                $('#assembliesTable').DataTable().destroy();
            }

            $('#assembliesTable').DataTable({
                pageLength: 10,
                language: {
                    search: "Search assemblies:",
                    lengthMenu: "Show _MENU_ assemblies",
                    info: "Showing _START_ to _END_ of _TOTAL_ assemblies",
                    emptyTable: "No assemblies available"
                },
                columnDefs: [
                    {
                        targets: -1,
                        orderable: false,
                        searchable: false
                    }
                ]
            });
        }

        function applyFilters() {
            const search = $('#assemblySearch').val();
            const table = $('#assembliesTable').DataTable();
            table.search(search).draw();
        }

        function clearFilters() {
            $('#assemblySearch').val('');
            const table = $('#assembliesTable').DataTable();
            table.search('').draw();
        }

        function reloadAssembliesTable() {
            $('#assembliesTableContainer').load('@Url.Action("AssembliesTable", "Assembly")', function () {
                initializeDataTable();
                loadAssemblies();
            });
        }

        function deleteAssembly(id) {

            Swal.fire({
                title: "Are you sure?",
                text: "This will permanently delete this assembly.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, delete it",
                confirmButtonColor: "#d33"
            }).then((result) => {

                if (result.isConfirmed) {

                    $.post('@Url.Action("Delete", "Assembly")', { id: id }, function (response) {

                        if (response.success) {
                            Swal.fire("Deleted!", response.message, "success")
                                .then(() => reloadAssembliesTable());
                        } else {
                            Swal.fire("Error", response.message, "error");
                        }

                    });
                }
            });
        }

        function editAssembly(id) {
            window.location.href = '@Url.Action("Edit", "Assembly")/' + id;
        }

        function viewAssembly(id) {
            window.location.href = '@Url.Action("Details", "Assembly")/' + id;
        }
                function submitAssemblyForm() {
            const form = $('#assemblyForm')[0];

            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Prepare data
            const dto = {
                Name: $('#assemblyName').val().trim(),
                Location: $('#assemblyLocation').val().trim(),
                Description: $('#assemblyDescription').val().trim(),
                ContactEmail: $('#assemblyEmail').val().trim() || null,
                ContactPhone: $('#assemblyPhone').val().trim() || null
            };

            // Disable button & show loading
            $('#saveAssemblyBtn').prop('disabled', true);
            $('#assemblyLoading').removeClass('d-none');

            $.ajax({
                url: '@Url.Action("SubmitNewAssembly", "Assemblies")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(dto),
                success: function(response) {
                    $('#assemblyLoading').addClass('d-none');
                    $('#saveAssemblyBtn').prop('disabled', false);

                    if (response.isSuccess) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Success',
                            text: 'Assembly created successfully!'
                        }).then(() => {
                            $('#assemblyModal').modal('hide');
                            reloadAssembliesTable(); // optional: refresh table
                        });
                    } else {
                        Swal.fire('Error', response.message || 'Failed to create assembly.', 'error');
                    }
                },
                error: function(xhr) {
                    $('#assemblyLoading').addClass('d-none');
                    $('#saveAssemblyBtn').prop('disabled', false);

                    let message = 'An unexpected error occurred.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        message = xhr.responseJSON.message;
                    }

                    Swal.fire('Error', message, 'error');
                }
            });
        }

        window.deleteAssembly = deleteAssembly;
        window.editAssembly = editAssembly;
        window.viewAssembly = viewAssembly;
    </script>

    <style>
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

            .stat-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.1) !important;
            }
    </style>
}
