@{
    ViewData["Title"] = "Events";
}

<!-- Page Header with Stats -->
<div class="row mb-4">
    <div class="col-md-8">
        <h2 class="fw-bold mb-1">Church Events</h2>
        <p class="text-muted mb-0">Manage and schedule all church activities and gatherings</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-success btn-lg me-2" onclick="downloadTemplate()">
            <i class="fa fa-download me-2"></i>Download Template
        </button>
        <a href="@Url.Action("CreateEvent", "Event")" class="btn btn-primary btn-lg">
            <i class="fa fa-plus-circle me-2"></i>Create New Event
        </a>
    </div>
</div>

<!-- Quick Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
        <div class="card border-0 shadow-sm stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                            <i class="fa fa-calendar text-primary fa-2x"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1">Total Events</h6>
                        <h3 class="fw-bold mb-0" id="totalEvents">0</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-6">
        <div class="card border-0 shadow-sm stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                            <i class="fa fa-clock text-success fa-2x"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1">Upcoming</h6>
                        <h3 class="fw-bold mb-0" id="upcomingEvents">0</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-6">
        <div class="card border-0 shadow-sm stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                            <i class="fa fa-money-bill text-warning fa-2x"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1">Paid Events</h6>
                        <h3 class="fw-bold mb-0" id="paidEvents">0</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-6">
        <div class="card border-0 shadow-sm stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-danger bg-opacity-10 p-3 rounded-circle">
                            <i class="fa fa-chart-line text-danger fa-2x"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1">This Month</h6>
                        <h3 class="fw-bold mb-0" id="monthEvents">0</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Bar -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-md-3">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-end-0">
                        <i class="fa fa-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-start-0" id="eventSearch" placeholder="Search events...">
                </div>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="eventType">
                    <option value="">All Types</option>
                    <option value="service">Service</option>
                    <option value="conference">Conference</option>
                    <option value="meeting">Meeting</option>
                    <option value="youth">Youth</option>
                    <option value="prayer">Prayer</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="eventStatus">
                    <option value="">All Status</option>
                    <option value="upcoming">Upcoming</option>
                    <option value="ongoing">Ongoing</option>
                    <option value="past">Past</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="paidFilter">
                    <option value="">All Events</option>
                    <option value="paid">Paid Events</option>
                    <option value="free">Free Events</option>
                </select>
            </div>
            <div class="col-md-3 text-end">
                <button class="btn btn-outline-secondary me-2" onclick="clearFilters()">
                    <i class="fa fa-times me-1"></i>Clear
                </button>
                <button class="btn btn-primary" onclick="applyFilters()">
                    <i class="fa fa-filter me-1"></i>Apply
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Toggle -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="btn-group" role="group">
        <button class="btn btn-outline-primary active" onclick="toggleView('table')">
            <i class="fa fa-table me-1"></i>Table View
        </button>
        <button class="btn btn-outline-primary" onclick="toggleView('calendar')">
            <i class="fa fa-calendar-alt me-1"></i>Calendar View
        </button>
        <button class="btn btn-outline-primary" onclick="toggleView('grid')">
            <i class="fa fa-th me-1"></i>Grid View
        </button>
    </div>
    <div>
        <button class="btn btn-outline-secondary me-2" onclick="exportEvents()">
            <i class="fa fa-file-excel me-1"></i>Export to Excel
        </button>
        <button class="btn btn-outline-secondary" onclick="showUploadModal()">
            <i class="fa fa-upload me-1"></i>Upload Events
        </button>
    </div>
</div>

<!-- Events Container -->
<div id="eventsTableContainer">
    @await Html.PartialAsync("_EventsTable")
</div>

<!-- Calendar View (Hidden by default) -->
<div id="calendarView" style="display: none;">
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div id="eventCalendar"></div>
        </div>
    </div>
</div>

<!-- Grid View (Hidden by default) -->
<div id="gridView" style="display: none;">
    <div class="row g-4" id="eventGrid">
        <!-- Events will be loaded here dynamically -->
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">
                    <i class="fa fa-upload me-2"></i>Upload Events from Excel
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fa fa-info-circle me-2"></i>
                    Please use the downloaded template format. The Excel file should match the template structure below.
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Upload Options</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="uploadOption" id="appendData" value="append" checked>
                        <label class="form-check-label" for="appendData">
                            Append to existing data
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="uploadOption" id="replaceData" value="replace">
                        <label class="form-check-label" for="replaceData">
                            Replace all data (clears existing)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="uploadOption" id="updateData" value="update">
                        <label class="form-check-label" for="updateData">
                            Update existing records (based on EventId)
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Choose File</label>
                    <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls,.csv">
                </div>

                <div class="progress mb-3" style="display: none;" id="uploadProgress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                </div>

                <div id="uploadPreview" class="mb-3" style="display: none;">
                    <h6>Preview:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead id="previewHeader"></thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadFile()" id="uploadBtn">
                    <i class="fa fa-upload me-1"></i>Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Toast Notification -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fa fa-check-circle me-2"></i>
                <span id="toastMessage">Operation completed successfully</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
    <!-- FullCalendar for calendar view -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>

    <!-- Moment.js for date handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- SheetJS for Excel handling -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- SweetAlert2 for better confirmations -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

            .stat-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.1) !important;
            }

        .event-card {
            transition: all 0.3s;
            border: 1px solid rgba(0,0,0,0.05);
        }

            .event-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            }

        .event-badge {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .btn-group .btn.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .fc-event {
            cursor: pointer;
        }

            .fc-event:hover {
                opacity: 0.9;
            }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        /* Action buttons */
        .action-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
        }

            .action-btn:hover {
                transform: translateY(-2px);
            }

            .action-btn.edit-btn:hover {
                background-color: #0d6efd;
                color: white;
            }

            .action-btn.delete-btn:hover {
                background-color: #dc3545;
                color: white;
            }

            .action-btn.view-btn:hover {
                background-color: #6c757d;
                color: white;
            }
    </style>

    <script>
        // Global variables
        let calendar = null;
        let currentView = 'table';
        let events = [];
        let selectedFile = null;

        $(document).ready(function() {
            loadEvents();
            initializeDataTable();

            // Check for success message from TempData
            @if (TempData["SuccessMessage"] != null)
            {
                        <text>
                        showToast('@TempData["SuccessMessage"]', 'success');
                        </text>
            }

            // Check for error message from TempData
            @if (TempData["ErrorMessage"] != null)
            {
                        <text>
                        showToast('@TempData["ErrorMessage"]', 'error');
                        </text>
            }
        });

        // Load events from server
        function loadEvents() {
            $.get('@Url.Action("GetEvents", "Event")', function(data) {
                events = data;
                updateStats();
                if (currentView === 'calendar') {
                    setTimeout(() => initializeCalendar(), 100);
                } else if (currentView === 'grid') {
                    renderGridView();
                }
            }).fail(function() {
                console.error('Failed to load events');
            });
        }

        // Update statistics
        function updateStats() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const monthEvents = events.filter(e => {
                const eventDate = new Date(e.eventDate);
                return eventDate.getMonth() === currentMonth && eventDate.getFullYear() === currentYear;
            }).length;

            const upcoming = events.filter(e => new Date(e.eventDate) > now).length;
            const paidEvents = events.filter(e => e.isPaid).length;

            $('#totalEvents').text(events.length);
            $('#upcomingEvents').text(upcoming);
            $('#paidEvents').text(paidEvents);
            $('#monthEvents').text(monthEvents);
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = $('#successToast');
            toast.removeClass('bg-success bg-danger bg-warning');

            if (type === 'success') {
                toast.addClass('bg-success');
                toast.find('i').removeClass().addClass('fa fa-check-circle me-2');
            } else if (type === 'error') {
                toast.addClass('bg-danger');
                toast.find('i').removeClass().addClass('fa fa-exclamation-circle me-2');
            } else if (type === 'warning') {
                toast.addClass('bg-warning');
                toast.find('i').removeClass().addClass('fa fa-exclamation-triangle me-2');
            }

            $('#toastMessage').text(message);
            const bsToast = new bootstrap.Toast(toast[0], { delay: 3000 });
            bsToast.show();
        }

        // Download Excel template
                  function downloadTemplate() {

            // MUST match ExcelEventDto column order exactly
            const template = [
                {
                    'Title': 'Easter Sunday Service',
                    'Description': 'Annual Easter celebration with special worship service',
                    'EventDate': '2026-03-31 09:00:00',
                    'Location': 'Main Sanctuary',
                    'IsPaid': 'FALSE',
                    'Price': '0'
                },
                {
                    'Title': 'Leadership Conference',
                    'Description': 'Annual leadership training conference',
                    'EventDate': '2026-06-15 09:00:00',
                    'Location': 'Fellowship Hall',
                    'IsPaid': 'TRUE',
                    'Price': '1500'
                },
                {
                    'Title': 'Christmas Eve Service',
                    'Description': 'Traditional Christmas Eve candlelight service',
                    'EventDate': '2026-12-24 18:00:00',
                    'Location': 'Main Sanctuary',
                    'IsPaid': 'FALSE',
                    'Price': '0'
                }
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(template);

            // Clean column widths
            ws['!cols'] = [
                { wch: 30 },  // Title
                { wch: 50 },  // Description
                { wch: 22 },  // EventDate
                { wch: 25 },  // Location
                { wch: 10 },  // IsPaid
                { wch: 12 }   // Price
            ];

            // ================= INSTRUCTIONS =================

            const instructions = [
                { 'Field': 'Title', 'Required': 'Yes', 'Description': 'Event title/name', 'Example': 'Easter Sunday Service' },
                { 'Field': 'Description', 'Required': 'No', 'Description': 'Event description', 'Example': 'Annual Easter celebration' },
                { 'Field': 'EventDate', 'Required': 'Yes', 'Description': 'Format: YYYY-MM-DD HH:MM:SS', 'Example': '2026-03-31 09:00:00' },
                { 'Field': 'Location', 'Required': 'Yes', 'Description': 'Event venue/location', 'Example': 'Main Sanctuary' },
                { 'Field': 'IsPaid', 'Required': 'Yes', 'Description': 'TRUE / FALSE or Yes / No', 'Example': 'FALSE' },
                { 'Field': 'Price', 'Required': 'If IsPaid = TRUE', 'Description': 'Numeric value only (no currency symbol)', 'Example': '1500' }
            ];

            const wsInstructions = XLSX.utils.json_to_sheet(instructions);

            wsInstructions['!cols'] = [
                { wch: 18 },
                { wch: 12 },
                { wch: 60 },
                { wch: 25 }
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Events');
            XLSX.utils.book_append_sheet(wb, wsInstructions, 'Instructions');

            XLSX.writeFile(wb, 'Events_Import_Template.xlsx');

            Swal.fire({
                icon: 'success',
                title: 'Template Downloaded',
                text: 'Events Excel template downloaded successfully.'
            });
        }

        // Show upload modal
        function showUploadModal() {
            $('#uploadModal').modal('show');

            // Reset form
            $('#excelFile').val('');
            $('#uploadPreview').hide();
            $('#uploadProgress').hide();
        }

        // Handle file selection
        $('#excelFile').on('change', function(e) {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                previewExcelFile(selectedFile);
            }
        });

        // Preview Excel file
        function previewExcelFile(file) {
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Get first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length > 0) {
                        // Get headers (first row)
                        const headers = jsonData[0];

                        // Get next 5 rows for preview
                        const previewRows = jsonData.slice(1, 6);

                        // Build preview table
                        let headerHtml = '<tr>';
                        headers.forEach(header => {
                            headerHtml += `<th>${header}</th>`;
                        });
                        headerHtml += '</tr>';

                        let bodyHtml = '';
                        previewRows.forEach(row => {
                            bodyHtml += '<tr>';
                            row.forEach(cell => {
                                bodyHtml += `<td>${cell || ''}</td>`;
                            });
                            bodyHtml += '</tr>';
                        });

                        $('#previewHeader').html(headerHtml);
                        $('#previewBody').html(bodyHtml);
                        $('#uploadPreview').show();
                    }
                } catch (error) {
                    console.error('Error previewing file:', error);
                    showToast('Error previewing file. Please check the format.', 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // Upload file
                function uploadFile() {

            var fileInput = document.getElementById("excelFile");
            var uploadOption = document.querySelector('input[name="uploadOption"]:checked').value;
            var progressBar = document.getElementById("uploadProgress");
            var progressBarInner = progressBar.querySelector(".progress-bar");

            if (fileInput.files.length === 0) {
                Swal.fire("Warning", "Please select an Excel file.", "warning");
                return;
            }

            var formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("uploadOption", uploadOption);

            progressBar.style.display = "block";
            progressBarInner.style.width = "0%";
            progressBarInner.innerText = "0%";

            $.ajax({
                url: '/Event/UploadEventsExcel',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                xhr: function () {
                    var xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener("progress", function (evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = Math.round((evt.loaded / evt.total) * 100);
                            progressBarInner.style.width = percentComplete + "%";
                            progressBarInner.innerText = percentComplete + "%";
                        }
                    }, false);
                    return xhr;
                },
                success: function (response) {

                    progressBar.style.display = "none";

                    Swal.fire({
                        icon: "success",
                        title: "Upload Completed",
                        html: `
                            <b>Total:</b> ${response.data.totalRecords} <br/>
                            <b>Successful:</b> ${response.data.successfulRecords} <br/>
                            <b>Failed:</b> ${response.data.failedRecords}
                        `
                    }).then(() => {
                        location.reload();
                    });
                },
                error: function (xhr) {

                    progressBar.style.display = "none";

                    let errorMessage = "Upload failed.";

                    if (xhr.responseJSON && xhr.responseJSON.message)
                        errorMessage = xhr.responseJSON.message;

                    Swal.fire("Error", errorMessage, "error");
                }
            });
        }
        // Edit event - redirect to edit page
        function editEvent(id) {
            window.location.href = '@Url.Action("Edit", "Event")/' + id;
        }

        // View event details - redirect to details page
        function viewEvent(id) {
            window.location.href = '@Url.Action("Details", "Event")/' + id;
        }

        // Delete event with SweetAlert2 confirmation
        function deleteEvent(id) {
            Swal.fire({
                title: 'Delete Event',
                text: 'Are you sure you want to delete this event? This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    return $.ajax({
                        url: '@Url.Action("Delete", "Event")',
                        type: 'POST',
                        data: { eventId: id },
                        dataType: 'json'
                    }).then(response => {
                        if (!response.success) {
                            throw new Error(response.message || 'Delete failed');
                        }
                        return response;
                    }).catch(error => {
                        Swal.showValidationMessage(`Request failed: ${error.message}`);
                    });
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    showToast('Event deleted successfully');
                    reloadEventsTable();
                    loadEvents();
                }
            });
        }

        // Toggle between views
        function toggleView(view) {
            currentView = view;

            // Update button states
            $('.btn-group .btn').removeClass('active');
            $(`.btn-group .btn:eq(${view === 'table' ? 0 : view === 'calendar' ? 1 : 2})`).addClass('active');

            // Hide all views
            $('#eventsTableContainer').hide();
            $('#calendarView').hide();
            $('#gridView').hide();

            // Show selected view
            if (view === 'table') {
                $('#eventsTableContainer').show();
                reloadEventsTable();
            } else if (view === 'calendar') {
                $('#calendarView').show();
                initializeCalendar();
            } else if (view === 'grid') {
                $('#gridView').show();
                renderGridView();
            }
        }

        // Initialize calendar
        function initializeCalendar() {
            const calendarEl = document.getElementById('eventCalendar');

            if (!calendarEl) return;

            if (calendar) {
                calendar.destroy();
            }

            const calendarEvents = events.map(e => ({
                id: e.eventId,
                title: e.title,
                start: e.eventDate,
                description: e.description,
                color: getEventColor(e),
                extendedProps: {
                    location: e.location,
                    isPaid: e.isPaid,
                    price: e.price
                }
            }));

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: calendarEvents,
                eventClick: function(info) {
                    viewEvent(info.event.id);
                },
                dateClick: function(info) {
                    window.location.href = '@Url.Action("Create", "Event")?date=' + info.dateStr;
                },
                height: 600,
                aspectRatio: 2,
                editable: false,
                eventDidMount: function(info) {
                    $(info.el).tooltip({
                        title: info.event.title + (info.event.extendedProps.location ? ' at ' + info.event.extendedProps.location : '') +
                               (info.event.extendedProps.isPaid ? ' ($' + info.event.extendedProps.price + ')' : ''),
                        placement: 'top',
                        trigger: 'hover',
                        container: 'body'
                    });
                }
            });

            calendar.render();
        }

        function getEventColor(event) {
            if (event.isPaid) return '#198754'; // Green for paid events
            return '#0d6efd'; // Blue for free events
        }

        // Render grid view
        function renderGridView() {
            const grid = $('#eventGrid');
            grid.empty();

            if (events.length === 0) {
                grid.html(`
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fa fa-calendar-times fa-4x text-muted mb-3"></i>
                            <h5>No Events Found</h5>
                            <p class="text-muted">Create your first event to get started</p>
                            <a href="@Url.Action("Create", "Event")" class="btn btn-primary mt-3">
                                <i class="fa fa-plus-circle me-2"></i>Create New Event
                            </a>
                        </div>
                    </div>
                `);
                return;
            }

            events.forEach(event => {
                const eventDate = moment(event.eventDate);
                const now = moment();
                const isUpcoming = eventDate.isAfter(now);
                const isPast = eventDate.isBefore(now);

                let statusBadge = '';
                if (isUpcoming) {
                    statusBadge = '<span class="event-badge badge bg-success">Upcoming</span>';
                } else if (isPast) {
                    statusBadge = '<span class="event-badge badge bg-secondary">Past</span>';
                }

                grid.append(`
                    <div class="col-md-4">
                        <div class="card event-card border-0 shadow-sm h-100">
                            ${statusBadge}
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-shrink-0">
                                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                                            <i class="fa fa-calendar text-primary fa-2x"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="card-title mb-1">${escapeHtml(event.title)}</h5>
                                        <p class="text-muted small mb-0">
                                            ${event.isPaid ?
                                                '<span class="badge bg-warning"><i class="fa fa-tag me-1"></i>$' + event.price + '</span>' :
                                                '<span class="badge bg-success">Free</span>'}
                                        </p>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <p class="small text-muted mb-2">
                                        <i class="fa fa-calendar-day me-2"></i>${eventDate.format('MMMM D, YYYY')}<br>
                                        <i class="fa fa-clock me-2"></i>${eventDate.format('h:mm A')}<br>
                                        <i class="fa fa-map-marker me-2"></i>${escapeHtml(event.location || 'TBD')}
                                    </p>
                                    <p class="small">${escapeHtml(event.description ? (event.description.substring(0, 100) + (event.description.length > 100 ? '...' : '')) : 'No description')}</p>
                                </div>

                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <span class="text-muted small">
                                        <i class="fa fa-clock-o me-1"></i>
                                        ${moment(event.createdAt).format('MMM D, YYYY')}
                                    </span>
                                    <div>
                                        <button class="action-btn view-btn btn btn-sm btn-outline-secondary me-1" onclick="viewEvent(${event.eventId})" title="View Details">
                                            <i class="fa fa-eye"></i>
                                        </button>
                                        <button class="action-btn edit-btn btn btn-sm btn-outline-primary me-1" onclick="editEvent(${event.eventId})" title="Edit">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button class="action-btn delete-btn btn btn-sm btn-outline-danger" onclick="deleteEvent(${event.eventId})" title="Delete">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            });
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

        // Reload events table
        function reloadEventsTable() {
            $('#eventsTableContainer').load('@Url.Action("EventsTable", "Event")', function() {
                initializeDataTable();
            });
        }

        // Initialize DataTable
        function initializeDataTable() {
            if ($.fn.DataTable.isDataTable('#eventsTable')) {
                $('#eventsTable').DataTable().destroy();
            }

            $('#eventsTable').DataTable({
                pageLength: 10,
                language: {
                    search: "Search events:",
                    lengthMenu: "Show _MENU_ events",
                    info: "Showing _START_ to _END_ of _TOTAL_ events",
                    emptyTable: "No events available",
                    zeroRecords: "No matching events found"
                },
                columnDefs: [
                    {
                        targets: -1,
                        orderable: false,
                        searchable: false
                    }
                ],
                initComplete: function() {
                    // Add action buttons styling
                    // Add action buttons styling
                    $('#eventsTable .btn-group .btn').addClass('action-btn');
                }
            });
        }

        // Filter functions
        function applyFilters() {
            const search = $('#eventSearch').val();
            const type = $('#eventType').val();
            const status = $('#eventStatus').val();
            const paidFilter = $('#paidFilter').val();

            if (currentView === 'table') {
                const table = $('#eventsTable').DataTable();
                table.search(search).draw();

                // Custom filtering for paid/free
                if (paidFilter === 'paid') {
                    // You would need to implement column filtering based on your table structure
                } else if (paidFilter === 'free') {
                    // Implement free filter
                }
            } else if (currentView === 'grid') {
                filterGridView(search, type, status, paidFilter);
            } else if (currentView === 'calendar') {
                filterCalendarView(search, type, status, paidFilter);
            }
        }

        function filterGridView(search, type, status, paidFilter) {
            // Simple client-side filtering for grid view
            const filteredEvents = events.filter(e => {
                let matches = true;

                if (search) {
                    matches = matches && (e.title.toLowerCase().includes(search.toLowerCase()) ||
                               (e.description && e.description.toLowerCase().includes(search.toLowerCase())));
                }

                if (paidFilter === 'paid') {
                    matches = matches && e.isPaid;
                } else if (paidFilter === 'free') {
                    matches = matches && !e.isPaid;
                }

                if (status) {
                    const now = moment();
                    const eventDate = moment(e.eventDate);

                    if (status === 'upcoming') {
                        matches = matches && eventDate.isAfter(now);
                    } else if (status === 'past') {
                        matches = matches && eventDate.isBefore(now);
                    }
                }

                return matches;
            });

            // Re-render with filtered events
            const tempEvents = events;
            events = filteredEvents;
            renderGridView();
            events = tempEvents;
        }

        function filterCalendarView(search, type, status, paidFilter) {
            // For calendar, we'll just show a message
            showToast('Filters applied to calendar view', 'info');
        }

        function clearFilters() {
            $('#eventSearch').val('');
            $('#eventType').val('');
            $('#eventStatus').val('');
            $('#paidFilter').val('');

            if (currentView === 'table') {
                const table = $('#eventsTable').DataTable();
                table.search('').columns().search('').draw();
            } else if (currentView === 'grid') {
                renderGridView();
            }
        }

        function deleteEvent(eventId) {

            Swal.fire({
                title: "Are you sure?",
                text: "This action will permanently delete this event.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, delete it",
                confirmButtonColor: "#d33"
            }).then((result) => {

                if (result.isConfirmed) {

                    Swal.fire({
                        title: "Processing...",
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    $.ajax({
                        url: '/Events/DeleteEvent', // Must match your controller route
                        type: 'POST',
                        data: {
                            eventId: eventId
                        },
                        success: function (response) {

                            Swal.fire("Success", response.message, "success")
                                .then(() => {
                                    location.reload();
                                });
                        },
                        error: function (xhr) {

                            let message = "Delete operation failed.";

                            if (xhr.responseJSON && xhr.responseJSON.message)
                                message = xhr.responseJSON.message;

                            Swal.fire("Error", message, "error");
                        }
                    });
                }
            });
        }


                
        function toggleEventStatus(eventId, activate) {

            let actionText = activate ? "activate" : "deactivate";

            Swal.fire({
                title: "Are you sure?",
                text: `You are about to ${actionText} this event.`,
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, proceed"
            }).then((result) => {

                if (result.isConfirmed) {

                    Swal.fire({
                        title: "Processing...",
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    $.ajax({
                        url: '/Event/ToggleStatus',
                        type: 'POST',
                        data: {
                            eventId: eventId,
                            isActive: activate
                        },
                        success: function (response) {

                            Swal.fire("Success", response.message, "success")
                                .then(() => {
                                    location.reload();
                                });
                        },
                        error: function (xhr) {

                            let message = "Operation failed.";

                            if (xhr.responseJSON && xhr.responseJSON.message)
                                message = xhr.responseJSON.message;

                            Swal.fire("Error", message, "error");
                        }
                    });
                }
            });
        }


        // Export events to Excel
        function exportEvents() {
            const exportData = events.map(e => ({
                'EventId': e.eventId,
                'Title': e.title,
                'Description': e.description,
                'EventDate': moment(e.eventDate).format('YYYY-MM-DD HH:mm:ss'),
                'Location': e.location,
                'IsPaid': e.isPaid ? 'TRUE' : 'FALSE',
                'Price': e.price || 0,
                'CreatedAt': moment(e.createdAt).format('YYYY-MM-DD HH:mm:ss'),
                'UpdatedAt': e.updatedAt ? moment(e.updatedAt).format('YYYY-MM-DD HH:mm:ss') : ''
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Set column widths
            const colWidths = [
                { wch: 10 }, // EventId
                { wch: 30 }, // Title
                { wch: 50 }, // Description
                { wch: 20 }, // EventDate
                { wch: 25 }, // Location
                { wch: 10 }, // IsPaid
                { wch: 10 }, // Price
                { wch: 20 }, // CreatedAt
                { wch: 20 }  // UpdatedAt
            ];
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, 'Events');
            XLSX.writeFile(wb, `Events_Export_${moment().format('YYYY-MM-DD')}.xlsx`);

            showToast('Events exported successfully', 'success');
        }

        // Handle delete confirmation from table
        window.deleteEvent = deleteEvent;
        window.editEvent = editEvent;
        window.viewEvent = viewEvent;
    </script>
}