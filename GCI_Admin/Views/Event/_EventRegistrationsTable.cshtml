@model List<GCI_Admin.Models.EventRegistration>

@{
    ViewData["Title"] = "Event Registrations";
}

@Html.AntiForgeryToken()

<div class="card shadow-sm">
    <div class="table-responsive p-3">
        <table id="eventRegistrationsTable" class="table table-striped table-hover align-middle datatable">

            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Member</th>
                    <th>Event</th>
                    <th>Amount Paid</th>
                    <th>Payment</th>
                    <th>Attended</th>
                    <th>Registered</th>
                    <th class="text-end">Actions</th>
                </tr>

                <!-- Filter Row -->
                <tr>
                    <th></th>
                    <th>
                        <input type="text" placeholder="Search Member" class="form-control form-control-sm" />
                    </th>
                    <th>
                        <input type="text" placeholder="Search Event" class="form-control form-control-sm" />
                    </th>
                    <th></th>
                    <th>
                        <select class="form-select form-select-sm">
                            <option value="">All</option>
                            <option value="Paid">Paid</option>
                            <option value="Pending">Pending</option>
                            <option value="Failed">Failed</option>
                        </select>
                    </th>
                    <th>
                        <select class="form-select form-select-sm">
                            <option value="">All</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>

            <tbody>
                @if (Model != null && Model.Any())
                {
                    int count = 1;
                    foreach (var r in Model)
                    {
                        <tr>
                            <td>@count</td>

                            <td>@($"{r.Member?.FirstName} {r.Member?.OtherNames}")</td>
                            <td>@r.Event?.Title</td>
                            <td>₵@r.AmountPaid.ToString("N2")</td>

                            <!-- Payment Badge -->
                            <td>
                                @if (r.PaymentStatusId == 1)
                                {
                                    <span class="badge bg-success">Paid</span>
                                }
                                else if (r.PaymentStatusId == 2)
                                {
                                    <span class="badge bg-warning text-dark">Pending</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Failed</span>
                                }
                            </td>

                            <!-- Attendance Badge -->
                            <td>
                                @if (r.HasAttended == true)
                                {
                                    <span class="badge bg-success">Yes</span>
                                }
                                else if (r.HasAttended == false)
                                {
                                    <span class="badge bg-secondary">No</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning">Unknown</span>
                                }
                            </td>

                            <td>@r.RegistrationDate.ToString("dd MMM yyyy")</td>

                            <!-- Actions -->
                            <td class="text-end">
                                <div class="btn-group btn-group-sm">

                                    <!-- Mark Attendance -->
                                    @if (r.HasAttended == false)
                                    {
                                        <button class="btn btn-outline-success"
                                                title="Mark as Attended"
                                                onclick="markAttended(@r.RegistrationId)">
                                            <i class="fa fa-check"></i>
                                        </button>
                                    }

                                    <!-- Delete -->
                                    <button class="btn btn-outline-danger"
                                            title="Delete"
                                            onclick="deleteRegistration(@r.RegistrationId)">
                                        <i class="fa fa-trash"></i>
                                    </button>

                                </div>
                            </td>
                        </tr>
                        count++;
                    }
                }
                else
                {
                    <tr>
                        <td class="text-center text-muted py-4">
                            No event registrations At the moment found
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        // MARK ATTENDANCE
        async function markAttended(id) {
            if (!confirm("Mark this member as attended?")) return;

            const response = await fetch('@Url.Action("MarkAttended", "EventRegistration")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                body: JSON.stringify({ id: id })
            });

            const result = await response.json();

            if (result.success) {
                location.reload();
            } else {
                alert(result.message || "Failed to update attendance.");
            }
        }

        // DELETE REGISTRATION
        async function deleteRegistration(id) {
            if (!confirm("Are you sure you want to delete this registration?")) return;

            const response = await fetch('@Url.Action("Delete", "EventRegistration")/' + id, {
                method: 'POST'
            });

            if (response.ok) {
                location.reload();
            } else {
                alert("Failed to delete registration.");
            }
        }

        // OPTIONAL: Initialize DataTables for search/filter inputs
        $(document).ready(function () {
            var table = $('#eventRegistrationsTable').DataTable({
                orderCellsTop: true,
                fixedHeader: true
            });

            $('#eventRegistrationsTable thead tr:eq(1) th').each(function (i) {
                $('input, select', this).on('keyup change', function () {
                    if (table.column(i).search() !== this.value) {
                        table.column(i).search(this.value).draw();
                    }
                });
            });
        });
    </script>
}