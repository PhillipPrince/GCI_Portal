@model List<GCI_Admin.Models.EventRegistration>

@{
    ViewData["Title"] = "Event Registrations";
}

@Html.AntiForgeryToken()

<div class="card shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Event Registrations</h5>
    </div>

    <div class="card-body p-3">

        <div class="table-responsive">
            <table id="eventRegistrationsTable" class="table table-hover align-middle w-100">

                <thead class="table-light">
                    <tr>
                        <th style="width:35px;"></th>
                        <th>#</th>
                        <th>Member</th>
                        <th>Event</th>
                        <th>Amount Paid</th>
                        <th>Payment</th>
                        <th>Attended</th>
                        <th>Registered</th>
                        <th class="text-end">Actions</th>
                    </tr>

                    <!-- FILTER ROW -->
                    <tr class="bg-white">
                        <th></th>
                        <th></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Member" /></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Event" /></th>
                        <th></th>
                        <th>
                            <select class="form-select form-select-sm">
                                <option value="">All</option>
                                <option>Paid</option>
                                <option>Pending</option>
                                <option>Failed</option>
                            </select>
                        </th>
                        <th>
                            <select class="form-select form-select-sm">
                                <option value="">All</option>
                                <option>Yes</option>
                                <option>No</option>
                            </select>
                        </th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>

                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        int count = 1;

                        foreach (var r in Model)
                        {
                            <tr>
                                <!-- Expand -->
                                <td class="text-center expand-row" style="cursor:pointer;">
                                    <i class="fa fa-chevron-right text-muted"></i>
                                </td>

                                <td>@count</td>

                                <td class="fw-semibold">
                                    @r.User?.FirstName @r.User?.OtherNames
                                </td>

                                <td>@r.Event?.Title</td>

                                <td>₵@r.AmountPaid.ToString("N2")</td>

                                <td>
                                    @if (r.PaymentStatusId == 1)
                                    {
                                        <span class="badge bg-success">Paid</span>
                                    }
                                    else if (r.PaymentStatusId == 2)
                                    {
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Failed</span>
                                    }
                                </td>

                                <td>
                                    @if (r.HasAttended == true)
                                    {
                                        <span class="badge bg-success">Yes</span>
                                    }
                                    else if (r.HasAttended == false)
                                    {
                                        <span class="badge bg-secondary">No</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning">Unknown</span>
                                    }
                                </td>

                                <td>
                                    @r.RegistrationDate.ToString("dd MMM yyyy")
                                </td>

                                <td class="text-end">

                                    <div class="btn-group btn-group-sm">

                                        <!-- Mark Attendance -->
                                        @if (r.HasAttended==false)
                                        {
                                            <button class="btn btn-outline-success"
                                                    title="Mark as Attended"
                                                    onclick="markAttended(@r.RegistrationId)">
                                                <i class="fa fa-check"></i>
                                            </button>
                                        }

                                <!-- Delete -->
                                <button class="btn btn-outline-danger"
                                        title="Delete"
                                        onclick="deleteRegistration(@r.RegistrationId)">
                                    <i class="fa fa-trash"></i>
                                </button>

                            </div>

                        </td>
                    </tr>

                    <!-- Expandable Child Row -->
                    <tr class="child-row d-none">
                        <td colspan="9">
                            <div class="p-3 bg-light rounded">
                                <div class="row">

                                    <div class="col-md-6">
                                        <h6>Member Details</h6>
                                        <strong>Email:</strong> @r.User?.Email <br />
                                        <strong>Phone:</strong> @r.User?.Phone <br />
                                        <strong>Assembly:</strong> @r.User?.Assembly
                                    </div>

                                    <div class="col-md-6">
                                        <h6>Event Details</h6>
                                        <strong>Date:</strong> @r.Event?.EventDate.ToString("dd MMM yyyy") <br />
                                        <strong>Location:</strong> @r.Event?.Location <br />
                                        <strong>Price:</strong>
                                        @(r.Event?.IsPaid == true
                                                                                ? $"₵{r.Event?.Price?.ToString("N2")}"
                                                                                : "Free")
                                    </div>

                                        </div>
                                    </div>
                                </td>
                            </tr>

                                        count++;
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                                No event registrations found
                            </td>
                        </tr>
                    }
                </tbody>

            </table>
        </div>

    </div>
</div>


@section Scripts {

    <script>

        // Expand / Collapse Row
        $(document).on("click", ".expand-row", function () {
            const icon = $(this).find("i");
            const childRow = $(this).closest("tr").next(".child-row");

            childRow.toggleClass("d-none");
            icon.toggleClass("fa-chevron-right fa-chevron-down");
        });


        // Mark Attendance
        async function markAttended(id) {

            if (!confirm("Mark this member as attended?"))
                return;

            const response = await fetch('@Url.Action("MarkAttended", "EventRegistration")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                body: JSON.stringify({ id: id })
            });

            const result = await response.json();

            if (result.success) {
                location.reload();
            } else {
                alert(result.message || "Failed to update attendance.");
            }
        }


        // Delete
        async function deleteRegistration(id) {

            if (!confirm("Are you sure you want to delete this registration?"))
                return;

            const response = await fetch('@Url.Action("Delete", "EventRegistration")/' + id, {
                method: 'POST'
            });

            if (response.ok) {
                location.reload();
            } else {
                alert("Failed to delete registration.");
            }
        }

    </script>

}
