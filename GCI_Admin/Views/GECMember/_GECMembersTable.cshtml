@model List<GCI_Admin.Models.GECMember>

<div class="table-responsive p-2">
    <table id="gecMembersTable" class="table table-striped table-hover w-100">
        <thead class="table-light">
            <tr>
                <th style="width:35px;"></th>
                <th style="width:50px;">#</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Gender</th>
                <th>Position</th>
                <th>Start Date</th>
                <th class="text-end">Actions</th>
            </tr>

            <!-- FILTER ROW -->
            <tr>
                <th></th>
                <th></th>
                <th><input type="text" placeholder="Search Name" class="form-control form-control-sm" /></th>
                <th><input type="text" placeholder="Phone" class="form-control form-control-sm" /></th>
                <th><input type="text" placeholder="Email" class="form-control form-control-sm" /></th>
                <th>
                    <select class="form-select form-select-sm">
                        <option value="">All</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </th>
                <th><input type="text" placeholder="Position" class="form-control form-control-sm" /></th>
                <th></th>
                <th></th>
            </tr>
        </thead>

        <tbody>
            @if (Model != null && Model.Any())
            {
                int count = 1;
                foreach (var m in Model)
                {
                  

                    <tr data-child>
                        <td class="text-center expand-row" style="cursor:pointer;">
                            <i class="fa fa-chevron-right text-muted"></i>
                        </td>

                        <td>@count</td>
                        <td>@m.FullName</td>
                        <td>@m.Phone</td>
                        <td>@m.Email</td>
                        <td>@m.Gender</td>
                        <td>@m.PositionTitle</td>
                        <td>@m.StartDate.ToString("dd MMM yyyy")</td>

                        <td class="text-end">
                            <!-- VIEW -->
                            <button class="btn btn-sm btn-outline-info"
                                    onclick="openModal('@Url.Action("Profile", "GECMember", new { id = m.GECId })')">
                                <i class="fa fa-eye"></i>
                            </button>

                            <!-- EDIT -->
                            <button class="btn btn-sm btn-outline-warning"
                                    onclick="openModal('@Url.Action("Edit", "GECMember", new { id = m.GECId })')">
                                <i class="fa fa-edit"></i>
                            </button>

                            <!-- DELETE -->
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteGECMember(@m.GECId)">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>

                    count++;
                }
            }
          
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        // Toggle child row using data-child attribute
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.expand-row').forEach(function (iconCell) {
                iconCell.addEventListener('click', function () {
                    var currentRow = this.closest('tr');
                    
                    // Check if child row already exists
                    var nextRow = currentRow.nextElementSibling;
                    var isChildRow = nextRow && nextRow.classList.contains('child-row');
                    
                    if (isChildRow) {
                        // Toggle existing child row
                        if (nextRow.style.display === 'none') {
                            nextRow.style.display = '';
                            this.querySelector('i').classList.remove('fa-chevron-right');
                            this.querySelector('i').classList.add('fa-chevron-down');
                        } else {
                            nextRow.style.display = 'none';
                            this.querySelector('i').classList.remove('fa-chevron-down');
                            this.querySelector('i').classList.add('fa-chevron-right');
                        }
                    } else {
                        // Create new child row from data-child attribute
                        var childContent = currentRow.getAttribute('data-child');
                        
                        if (childContent) {
                            var newRow = document.createElement('tr');
                            newRow.className = 'child-row';
                            newRow.innerHTML = '<td colspan="9">' + childContent + '</td>';
                            
                            currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
                            
                            // Update icon
                            this.querySelector('i').classList.remove('fa-chevron-right');
                            this.querySelector('i').classList.add('fa-chevron-down');
                        }
                    }
                });
            });
        });

        // Delete GEC member
        async function deleteGECMember(id) {
            if (!confirm("Are you sure you want to delete this member?")) return;

            try {
                // Get anti-forgery token
                const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
                
                const response = await fetch('@Url.Action("Delete", "GECMember")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(tokenElement && { 'RequestVerificationToken': tokenElement.value })
                    },
                    body: JSON.stringify({ id: id })
                });

                const data = await response.json();
                if (response.ok) {
                    alert(data.message || "Member deleted successfully");
                    location.reload();
                } else {
                    alert(data.message || "Failed to delete member");
                }
            } catch (error) {
                alert("An error occurred while deleting the member");
            }
        }
    </script>
}