@{
    ViewData["Title"] = "GEC Members";
}

<!-- Page Header with Stats -->
<div class="row mb-4">
    <div class="col-md-8">
        <h2 class="fw-bold mb-1">GEC Members</h2>
        <p class="text-muted mb-0">Manage Greater Evangelical Council members and their positions</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-primary btn-lg" onclick="showCreateModal()">
            <i class="fa fa-plus-circle me-2"></i>Add New Member
        </button>
    </div>
</div>

<!-- Quick Stats Cards (same as before) -->
<div class="row g-3 mb-4">
    <!-- ... stats cards ... -->
</div>

<!-- Filter Bar (same as before) -->
<div class="card border-0 shadow-sm mb-4">
    <!-- ... filter bar ... -->
</div>

<!-- Members Container -->
<div id="gecMembersTableContainer">
    @await Html.PartialAsync("_GECMembersTable", (List<GCI_Admin.Models.GECMember>)ViewBag.GECMembers ?? new List<GCI_Admin.Models.GECMember>())
</div>

<!-- Modal Container -->
<div class="modal fade" id="memberModal" tabindex="-1" aria-labelledby="memberModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="memberModalLabel">
                    <i class="fa fa-user-plus me-2"></i><span id="modalTitle">Add New GEC Member</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Partial view will be loaded here -->
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitMemberForm()" id="saveBtn">
                    <i class="fa fa-save me-1"></i>Save Member
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Toast Notification -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fa fa-check-circle me-2"></i>
                <span id="toastMessage">Operation completed successfully</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Select2 for searchable dropdown -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

    <style>
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

            .stat-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.1) !important;
            }

        .action-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
        }

            .action-btn:hover {
                transform: translateY(-2px);
            }

        .select2-container--default .select2-selection--single {
            height: 38px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

            .select2-container--default .select2-selection--single .select2-selection__rendered {
                line-height: 36px;
            }

            .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: 36px;
            }

        .member-option {
            padding: 8px 12px;
        }

            .member-option strong {
                font-size: 14px;
            }

            .member-option small {
                display: block;
                color: #6c757d;
                font-size: 12px;
            }
    </style>

    <script>
        $(document).ready(function() {
            loadStats();
            initializeDataTable();
            attachExpandRowListeners();
        });

        // Show create modal
        function showCreateModal() {
            $('#modalTitle').text('Add New GEC Member');
            $('#modalBody').html('<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');
            $('#memberModal').modal('show');

            // Load the create form partial view
            $.get('@Url.Action("LoadCreateForm", "GECMember")', function(data) {
                $('#modalBody').html(data);
            }).fail(function() {
                $('#modalBody').html('<div class="alert alert-danger">Failed to load form. Please try again.</div>');
            });
        }

        // Show edit modal
        function showEditModal(id) {
            $('#modalTitle').text('Edit GEC Member');
            $('#modalBody').html('<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');
            $('#memberModal').modal('show');

            // Load the edit form partial view
            $.get('@Url.Action("LoadEditForm", "GECMember")', { id: id }, function(data) {
                $('#modalBody').html(data);
            }).fail(function() {
                $('#modalBody').html('<div class="alert alert-danger">Failed to load form. Please try again.</div>');
            });
        }

        // Submit the form inside the modal
        function submitMemberForm() {
            // Check which form exists
            let form = $('#createMemberForm');
            let isCreate = form.length > 0;

            if (!isCreate) {
                form = $('#editMemberForm');
            }

            if (form.length === 0) {
                showToast('Form not found', 'error');
                return;
            }

            // Validate form
            if (!form[0].checkValidity()) {
                form[0].reportValidity();
                return;
            }

            // Show loading
            $('#saveBtn').prop('disabled', true).html('<i class="fa fa-spinner fa-spin me-1"></i>Saving...');

            // Submit form via AJAX
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        $('#memberModal').modal('hide');
                        showToast(response.message || (isCreate ? 'Member created successfully' : 'Member updated successfully'));
                        refreshGECTable();
                        loadStats();
                    } else {
                        if (response.errors) {
                            let errorMsg = response.errors.join(', ');
                            showToast(errorMsg, 'error');
                        } else {
                            showToast(response.message || 'Operation failed', 'error');
                        }
                    }
                },
                error: function(xhr) {
                    let message = 'An error occurred';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        message = xhr.responseJSON.message;
                    }
                    showToast(message, 'error');
                },
                complete: function() {
                    $('#saveBtn').prop('disabled', false).html('<i class="fa fa-save me-1"></i>Save Member');
                }
            });
        }

        // Load statistics
        function loadStats() {
            $.get('@Url.Action("GetStats", "GECMember")', function(data) {
                $('#totalMembers').text(data.totalMembers || 0);
                $('#activeMembers').text(data.activeMembers || 0);
                $('#totalPositions').text(data.totalPositions || 0);
                $('#newThisMonth').text(data.newThisMonth || 0);
            }).fail(function() {
                console.error('Failed to load stats');
            });
        }

        // Initialize DataTable
        function initializeDataTable() {
            if ($.fn.DataTable.isDataTable('#gecMembersTable')) {
                $('#gecMembersTable').DataTable().destroy();
            }

            $('#gecMembersTable').DataTable({
                pageLength: 10,
                language: {
                    search: "Search members:",
                    lengthMenu: "Show _MENU_ members",
                    info: "Showing _START_ to _END_ of _TOTAL_ members",
                    emptyTable: "No members available",
                    zeroRecords: "No matching members found"
                },
                columnDefs: [
                    {
                        targets: -1,
                        orderable: false,
                        searchable: false
                    }
                ]
            });
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = $('#successToast');
            toast.removeClass('bg-success bg-danger bg-warning');

            if (type === 'success') {
                toast.addClass('bg-success');
                toast.find('i').removeClass().addClass('fa fa-check-circle me-2');
            } else if (type === 'error') {
                toast.addClass('bg-danger');
                toast.find('i').removeClass().addClass('fa fa-exclamation-circle me-2');
            } else if (type === 'warning') {
                toast.addClass('bg-warning');
                toast.find('i').removeClass().addClass('fa fa-exclamation-triangle me-2');
            }

            $('#toastMessage').text(message);
            const bsToast = new bootstrap.Toast(toast[0], { delay: 3000 });
            bsToast.show();
        }

        // Refresh the table dynamically
        async function refreshGECTable() {
            try {
                const response = await fetch('@Url.Action("GetMembersTable", "GECMember")');
                const html = await response.text();
                document.getElementById('gecMembersTableContainer').innerHTML = html;
                initializeDataTable();
                attachExpandRowListeners();
            } catch (error) {
                console.error('Failed to refresh table:', error);
                showToast('Failed to refresh table', 'error');
            }
        }

        // Attach expand row listeners
        function attachExpandRowListeners() {
            document.querySelectorAll('.expand-row').forEach(function (iconCell) {
                iconCell.removeEventListener('click', toggleChildRow);
                iconCell.addEventListener('click', toggleChildRow);
            });
        }

        // Toggle child row function
        function toggleChildRow() {
            const currentRow = this.closest('tr');
            const nextRow = currentRow.nextElementSibling;
            const isChildRow = nextRow && nextRow.classList.contains('child-row');

            if (isChildRow) {
                if (nextRow.style.display === 'none') {
                    nextRow.style.display = '';
                    this.querySelector('i').classList.remove('fa-chevron-right');
                    this.querySelector('i').classList.add('fa-chevron-down');
                } else {
                    nextRow.style.display = 'none';
                    this.querySelector('i').classList.remove('fa-chevron-down');
                    this.querySelector('i').classList.add('fa-chevron-right');
                }
            } else {
                const childContent = currentRow.getAttribute('data-child');
                if (childContent) {
                    const newRow = document.createElement('tr');
                    newRow.className = 'child-row';
                    newRow.innerHTML = '<td colspan="9">' + childContent + '</td>';
                    currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
                    this.querySelector('i').classList.remove('fa-chevron-right');
                    this.querySelector('i').classList.add('fa-chevron-down');
                }
            }
        }

        // Delete member
        function deleteGECMember(id) {
            Swal.fire({
                title: 'Delete Member',
                text: 'Are you sure you want to delete this member? This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    const token = $('input[name="__RequestVerificationToken"]').val();

                    return $.ajax({
                        url: '@Url.Action("Delete", "GECMember")',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ id: id }),
                        headers: {
                            'RequestVerificationToken': token
                        },
                        dataType: 'json'
                    }).then(response => {
                        if (!response.success) {
                            throw new Error(response.message || 'Delete failed');
                        }
                        return response;
                    }).catch(error => {
                        Swal.showValidationMessage(`Request failed: ${error.message}`);
                    });
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    showToast(result.value.message || 'Member deleted successfully');
                    refreshGECTable();
                    loadStats();
                }
            });
        }

        // Filter functions
        function applyFilters() {
            // ... filter implementation ...
        }

        function clearFilters() {
            // ... clear filters implementation ...
        }

        // View member profile
        function viewMember(id) {
            window.location.href = '@Url.Action("Profile", "GECMember")/' + id;
        }

        // Make functions globally accessible
        window.showEditModal = showEditModal;
        window.deleteGECMember = deleteGECMember;
        window.viewMember = viewMember;
        window.submitMemberForm = submitMemberForm;
    </script>
}