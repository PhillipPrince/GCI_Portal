@model List<GCI_Admin.Models.GECMember>

@{
    ViewData["Title"] = "GEC Members Management";
}

<!-- Page Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <h2 class="fw-bold mb-1">GEC Members</h2>
        <p class="text-muted mb-0">Manage General Executive Council members</p>
    </div>
    <div class="col-md-4 d-flex justify-content-end">
        <button class="btn btn-primary btn-lg" id="openAddMemberModalBtn">
            <i class="fa fa-plus-circle me-2"></i>Add New Member
        </button>
    </div>
</div>

<!-- Quick Stats for Members -->
<div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
        <div class="card border-0 shadow-sm stat-card">
            <div class="card-body">
                <h6 class="text-muted mb-1">Total Members</h6>
                <h3 class="fw-bold mb-0">@Model?.Count ?? 0</h3>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-6">
        <div class="card border-0 shadow-sm stat-card">
            <div class="card-body">
                <h6 class="text-muted mb-1">Active Members</h6>
                <h3 class="fw-bold mb-0 text-success">@Model?.Count(m => m.IsActive) ?? 0</h3>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-6">
        <div class="card border-0 shadow-sm stat-card">
            <div class="card-body">
                <h6 class="text-muted mb-1">Positions</h6>
                <h3 class="fw-bold mb-0">@Model?.Select(m => m.PositionTitle).Distinct().Count() ?? 0</h3>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-6">
        <div class="card border-0 shadow-sm stat-card">
            <div class="card-body">
                <h6 class="text-muted mb-1">New This Month</h6>
                <h3 class="fw-bold mb-0">@Model?.Count(m => m.CreatedAt >= DateTime.Now.AddDays(-30)) ?? 0</h3>
            </div>
        </div>
    </div>
</div>

<!-- Filter Bar -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-end-0">
                        <i class="fa fa-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-start-0" id="memberSearch" placeholder="Search members...">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-outline-secondary me-2" onclick="clearMemberFilters()">
                    <i class="fa fa-times me-1"></i>Clear
                </button>
                <button class="btn btn-primary" onclick="applyMemberFilters()">
                    <i class="fa fa-filter me-1"></i>Apply
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Members Table -->
<div id="gecMembersTableContainer">
    @await Html.PartialAsync("_GECMembersTable", Model)
</div>

<!-- Member Modal -->
<div class="modal fade" id="memberModal" tabindex="-1" aria-labelledby="memberModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="memberModalLabel">
                    <i class="fa fa-user-plus me-2"></i>
                    <span id="modalTitleMember">Add New Member</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="memberModalBody">
                <div class="text-center p-4 d-none" id="memberLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitMemberForm()" id="saveMemberBtn">
                    <i class="fa fa-save me-1"></i>Save Member
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Open Add Member Modal
            $('#openAddMemberModalBtn').on('click', function () {
                $('#memberModal').modal('show');
                $('#modalTitleMember').text('Add New Member');
                $('#memberModalBody').html('<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');
                $('#saveMemberBtn').prop('disabled', false);

                $.get('@Url.Action("LoadCreateForm", "GECMember")', function (data) {
                    $('#memberModalBody').html(data);
                }).fail(function () {
                    $('#memberModalBody').html('<div class="alert alert-danger">Failed to load form. Please try again.</div>');
                });
            });
        });

        function applyMemberFilters() {
            const search = $('#memberSearch').val();
            const table = $('#gecMembersTable').DataTable();
            table.search(search).draw();
        }

        function clearMemberFilters() {
            $('#memberSearch').val('');
            const table = $('#gecMembersTable').DataTable();
            table.search('').draw();
        }

        function submitMemberForm() {
            const form = $('#createMemberForm, #editMemberForm').first();
            if (!form.length) return;

            if (!form[0].checkValidity()) { form[0].reportValidity(); return; }

            $('#saveMemberBtn').prop('disabled', true);
            $('#memberLoading').removeClass('d-none');

            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: form.serialize(),
                success: function (response) {
                    $('#memberLoading').addClass('d-none');
                    $('#saveMemberBtn').prop('disabled', false);

                    if (response.success) {
                        $('#memberModal').modal('hide');
                        location.reload();
                    } else {
                        Swal.fire('Error', response.message || 'Failed to save member.', 'error');
                    }
                },
                error: function () {
                    $('#memberLoading').addClass('d-none');
                    $('#saveMemberBtn').prop('disabled', false);
                    Swal.fire('Error', 'An unexpected error occurred.', 'error');
                }
            });
        }
    </script>
}
