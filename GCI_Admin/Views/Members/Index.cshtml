@model List<Member>

@{
    ViewData["Title"] = "Members";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold mb-0">Church Members</h4>
    <button class="btn btn-primary" onclick="openModal('@Url.Action("Create")')">
        <i class="fa fa-user-plus me-1"></i> Add Member
    </button>
</div>

<div class="card shadow-sm h-100">
    <div class="table-responsive p-2">

        <table id="membersTable" class="table table-striped table-hover w-100">
            <thead class="table-light">
                <tr>
                    <th style="width:35px;"></th> <!-- Expand icon -->
                    <th style="width:50px;">#</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Gender</th>
                    <th>Assembly</th>
                    <th>Joined</th>
                    <th class="text-end">Actions</th>
                </tr>

                <!-- FILTER ROW -->
                <tr>
                    <th></th>
                    <th></th>
                    <th><input type="text" placeholder="Search Name" class="form-control form-control-sm" /></th>
                    <th><input type="text" placeholder="Phone" class="form-control form-control-sm" /></th>
                    <th><input type="text" placeholder="Email" class="form-control form-control-sm" /></th>
                    <th>
                        <select class="form-select form-select-sm">
                            <option value="">All</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </th>
                    <th><input type="text" placeholder="Assembly" class="form-control form-control-sm" /></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>

            <tbody>
                @{
                    int count = 1;
                }

                @foreach (var m in Model)
                {
                    var childContent = $@"
                                <div class='p-2 small'>
                                <strong>Gender:</strong> {m.Gender}<br/>
                                <strong>Email:</strong> {m.Email}<br/>
                                <strong>Phone:</strong> {m.Phone}<br/>
                                <strong>Assembly:</strong> {m.Assembly}<br/>
                                <strong>Joined:</strong> {m.CreatedAt:dd MMM yyyy}
                                </div>
                                ";

                    <tr data-child="@childContent">
                        <!-- Expand Icon -->
                        <td class="text-center expand-row">
                            <i class="fa fa-chevron-right text-muted"></i>
                        </td>

                        <!-- Row Number -->
                        <td>@count</td>

                        <!-- Member Info -->
                        <td>@m.FirstName @m.OtherNames</td>
                        <td>@m.Phone</td>
                        <td>@m.Email</td>
                        <td>@m.Gender</td>
                        <td>@m.Assembly</td>
                        <td>@m.CreatedAt.ToString("dd MMM yyyy")</td>

                        <!-- Actions -->
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-info" onclick="openModal('@Url.Action("Profile", new { id = m.Id })')">
                                <i class="fa fa-eye"></i>
                            </button>

                            <button class="btn btn-sm btn-outline-warning" onclick="openModal('@Url.Action("Edit", new { id = m.Id })')">
                                <i class="fa fa-edit"></i>
                            </button>

                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMember(@m.Id)">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>

                    count++;
                }
            </tbody>
        </table>

    </div>
</div>


<div class="modal fade" id="globalModal">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-scrollable">
        <div class="modal-content shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Member</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalContent"></div>
        </div>
    </div>
</div>

@section Scripts {

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <script>
        $(document).ready(function () {

            var table = $('#membersTable').DataTable({
                responsive: true,
                pageLength: 10,
                lengthMenu: [10, 25, 50, 100],
                order: [[7, "desc"]],
                autoWidth: false
            });

            // Auto row numbers
            table.on('order.dt search.dt', function () {
                let i = 1;
                table.column(1, { search: 'applied', order: 'applied' }).nodes()
                    .each(cell => cell.innerHTML = i++);
            }).draw();

            // Column filtering
            $('#membersTable thead tr:eq(1) th').each(function (i) {
                $('input, select', this).on('keyup change', function () {
                    table.column(i).search(this.value).draw();
                });
            });

            // Expandable rows
            $('#membersTable tbody').on('click', '.expand-row', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr);

                if (row.child.isShown()) {
                    row.child.hide();
                    $(this).find('i').removeClass('fa-minus-circle').addClass('fa-plus-circle');
                } else {
                    row.child(tr.data('child')).show();
                    $(this).find('i').removeClass('fa-plus-circle').addClass('fa-minus-circle');
                }
            });

        });

        // Modal loader
        function openModal(url) {
            $('#modalContent').html('<div class="text-center py-5"><i class="fa fa-spinner fa-spin fa-2x"></i></div>');
            $('#modalContent').load(url, function () {
                $('#globalModal').modal('show');
            });
        }

        function deleteMember(id) {
            if (!confirm("Delete this member?")) return;

            $.post('/Members/Delete', { id }, function () {
                location.reload();
            });
        }
    </script>
}

